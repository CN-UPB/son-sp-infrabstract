<html>
<head>
<script src="d3.v4.min.js"></script>
<script src="cola.v3.js"></script>
<script src="d3-scale.v1.min.js"></script>
<script src="d3-array.v1.min.js"></script>
<script src="d3-collection.v1.min.js"></script>
<script src="d3-color.v1.min.js"></script>
<script src="d3-format.v1.min.js"></script>
<script src="d3-interpolate.v1.min.js"></script>
<script src="d3-time.v1.min.js"></script>
<script src="d3-time-format.v2.min.js"></script>
<style>
body {
    margin:0;
}
#topstatus {
    border-bottom:solid 1px #000;
}
.vnfMonitor {
    background-color: #ddd;
}
.vnfMonitorLabel {
   /* clear: both;*/
}
.vnfMonitorCpu {
   /* float: left;*/
    width: 500px;
    height: 400px;
    border: solid 1px #000;
}
.vnfMonitorMem {
   /* float: left;*/
    width: 500px;
    height: 400px;
    border: solid 1px #000;
}
}
</style>
<script type="text/javascript">

actionPending = false;
currentStatus = null;

function ajax(method, path, params, type, callback){
    var xmlHttp = null;
    xmlHttp = new XMLHttpRequest();
    if (xmlHttp) {
        xmlHttp.open(method, path, true);
        if (type != null)
            xmlHttp.responseType = type;
        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4) {
                callback(xmlHttp.status, xmlHttp.response);
            }
        };
        xmlHttp.send(params);
    }
}

function setStatusMsg(msg, style){
    var statusNode = document.getElementById("status");
    while(statusNode.childNodes.length>0)
        statusNode.removeChild(statusNode.firstChild);
    statusNode.style = style;
    statusNode.appendChild(document.createTextNode(msg));
}

function onStatus(status, response){
    if(status == 200) {
        newstatus = response;
        if(newstatus.status == "DEPLOYED") {
            document.getElementById("undeploybtn").disabled = false;
            setStatusMsg(newstatus.status, "color:green;");
        }
        if(newstatus.status == "UNDEPLOYED") {
            document.getElementById("undeploybtn").disabled = true;
            setStatusMsg(newstatus.status, "color:red;");
        }
        // Check for status change and update appropriate information
        if(currentStatus == null || currentStatus.packageCount != newstatus.packageCount)
            getPkgList();
        currentStatus = newstatus;
    }
    document.getElementById("statusbtn").disabled = false;
    actionPending = false;
}

function checkStatus(){
    document.getElementById("statusbtn").disabled = true;
    setStatusMsg("Checking Status", "color:orange;");
    ajax("GET", "/status/status", null, "json", onStatus);
}

function onUndeploy(status, response){
    checkStatus();
}

function undeploy() {
    if(actionPending == true)
        return;
    actionPending = true;
    document.getElementById("undeploybtn").disabled = true;
    setStatusMsg("Undeploying", "color:orange;");
    ajax("GET", "/undeploy", null, "json", onUndeploy);
}

function onDeploy(status, response){
    if(status == 201) {        
    } else {
    }
    checkStatus();
}

function deployPkg(index){
    if(actionPending == true)
        return;
    actionPending = true;
    setStatusMsg("Deploying", "color:orange;");
    ajax("POST", "/deploy", "asdf="+index, "json", onDeploy);
}

function setPkgList(status, response){
    console.log(response);
    if(status != 200) {
        console.log("Package request unsuccessful");
        return;
    }
    if (response != null) {
        var ul = document.createElement("ul");
        for (var i=0; i<response.length; i++) {
            var node = response[i];
            var li = document.createElement("li");
            var name = document.createTextNode(node.name+"  ");
            var btn = document.createElement("button");
            btn.appendChild(document.createTextNode("Deploy"));
            btn.addEventListener('click',deployPkg.bind(this,i));
            btn.class="deploybtn";
            li.appendChild(name);
            li.appendChild(btn);
            ul.appendChild(li);
        }
        var pkglist = document.getElementById("pkglist");
        while(pkglist.childNodes.length > 0)
            pkglist.removeChild(pkglist.firstChild);
        pkglist.appendChild(document.createTextNode("Packages: "+response.length));
        //pkglist.appendChild(document.createElement("br"));
        pkglist.appendChild(ul);
    }
}

function getPkgList() {
    ajax("GET", serverPrefix+"/status/packages", null ,"json", setPkgList);
}

currentMonitorFunctionList = null;
currentMonitorData = null;
currentMonitorD3 = null;
currentMonitorDivs = null;

function removeMonitorView() {
    var monitordiv = document.getElementById("monitordiv");
    while(monitordiv.childNodes.length > 0)
        monitordiv.removeChild(monitordiv.firstChild);
    currentMonitorData = null;
}

function updateMonitorView(monitorData) {
    if(currentMonitorData == null)
        return;
    var newFunctionList = monitorData.monitorFunctions;
    var newFunctions = [];
    var deletedFunctions = [];
    var oldFunctions = [];
    // Get new and old functions
    for(var i=0; i<newFunctionList.length; i++) {
        if(currentMonitorFunctionList.indexOf(newFunctionList[i])<0)
            newFunctions.push(newFunctionList[i]);
        else
            oldFunctions.push(newFunctionList[i]);
    }
    // Get deleted functions
    for(var i=0; i<currentMonitorFunctionList.length; i++) {
        if(newFunctionList.indexOf(currentMonitorFunctionList[i])<0)
            deletedFunctions.push(currentMonitorFunctionList[i]);
    }
    // Update label style for deleted functions
    for(var i=0; i<deletedFunctions.length; i++) {
        currentMonitorDivs[deletedFunctions[i]].firstChild.style = "text-decoration: line-through;";
    }
    // Create divs/d3 for new functions
    var monitordiv = document.getElementById("monitordiv");
    var functionDivList = [];
    for(var i=0; i<newFunctions.length; i++) {
        var newFunctionDiv = document.createElement("div");
        newFunctionDiv.setAttribute("class","vnfMonitor");
        var monitorLabelDiv = document.createElement("div");
        monitorLabelDiv.setAttribute("class","vnfMonitorLabel");
        monitorLabelDiv.appendChild(document.createTextNode(functionList[i]));
        var newCpuDiv = document.createElement("div");
        newCpuDiv.setAttribute("class","vnfMonitorCpu");
        var newMemDiv = document.createElement("div");
        newMemDiv.setAttribute("class","vnfMonitorMem");
        newFunctionDiv.appendChild(monitorLabelDiv);
        newFunctionDiv.appendChild(newCpuDiv);
        newFunctionDiv.appendChild(newMemDiv);
        // Add d3 stuff
        var cpuSvg = document.createElement("svg");
        var cpuSvgd3 = d3.select(cpuSvg);
        var cpud3 = setupD3Svg(cpuSvgd3, newFunctions[i], monitorData.monitorHistoryData[newFunctions[i]], "CPU_%");
        var memSvg = document.createElement("svg");
        var memSvgd3 = d3.select(memSvg);
        var memd3 = setupD3Svg(memSvgd3, newFunctions[i], monitorData.monitorHistoryData[newFunctions[i]], "MEM_%");
        newCpuDiv.appendChild(cpuSvg);
        newMemDiv.appendChild(memSvg);
        currentMonitorD3[newFunctions[i]] = {cpu:cpud3,mem:memd3};
        currentMonitorDivs[newFunctions[i]] = newFunctionDiv;
        functionDivList.push(newFunctionDiv);
    }
    for (var i=0; i<functionDivList; i++) {
        monitordiv.appendChild(functionDivList[i]);
    }
    // Update data for old functions
    for(var i=0; i<oldFunctions.length; i++) {
        var datapath = currentMonitorD3[oldFunctions[i]];
        datapath.datum(data);
    }
    currentMonitorData = monitorData;
    currentMonitorFunctionList = newFunctionList;
}

function setupD3Svg(svg, name, data, dataKey) {
    var width = 500;
    var height = 400;
    var margin = {top: 2, right: 2, bottom: 3, left: 5};
    svg.attr("width", width);
    svg.attr("height", height);
    var svgWidth = +svg.attr("width") - margin.left - margin.right;
    var svgHeight = +svg.attr("height") - margin.top - margin.bottom;
    var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    var x = d3.scaleTime()
    .rangeRound([0, width]);
    var y = d3.scaleLinear()
    .rangeRound([height, 0]);
    var line = d3.line()
    .x(function(d) { return x(new Date(d["SYS_time"]/1000000)); })
    .y(function(d) { return y(d[dataKey]); });
    x.domain(d3.extent(data, function(d) { return new Date(d["SYS_time"]/1000000); }));
    y.domain(d3.extent(data, function(d) { return d[dataKey]; }));

    g.append("g")
       .attr("class", "axis axis--x")
       .attr("transform", "translate(0," + height + ")")
       .call(d3.axisBottom(x));

    g.append("g")
      .attr("class", "axis axis--y")
      .call(d3.axisLeft(y));
    /*
    .append("text")
      .attr("fill", "#000")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", "0.71em")
      .style("text-anchor", "end")
      .text("Price ($)");
    */

    var datapath = g.append("path")
      .datum(data)
      .attr("class", "line")
      .attr("d", line);
    return datapath;
}

function createMonitorView(monitorData) {
    console.log("createMonitorView");
    var monitordiv = document.getElementById("monitordiv");
    var functionList = monitorData.monitorFunctions;
    var functionDivList = [];
    currentMonitorD3 = {};
    currentMonitorDivs = {};
    var dummy = [{"SYS_time":123,"CPU_used":123,"MEM_used":123},{"SYS_time":125,"CPU_used":123,"MEM_used":123},{"SYS_time":124,"CPU_used":123,"MEM_used":123}];
    for (var i=0; i<functionList.length; i++) {
        console.log("create div for function "+functionList[i]);
        var newFunctionDiv = document.createElement("div");
        newFunctionDiv.setAttribute("class","vnfMonitor");
        var monitorLabelDiv = document.createElement("div");
        monitorLabelDiv.setAttribute("class","vnfMonitorLabel");
        monitorLabelDiv.appendChild(document.createTextNode(functionList[i]));
        var newCpuDiv = document.createElement("div");
        newCpuDiv.setAttribute("class","vnfMonitorCpu");
        var newMemDiv = document.createElement("div");
        newMemDiv.setAttribute("class","vnfMonitorMem");
        newFunctionDiv.appendChild(monitorLabelDiv);
        newFunctionDiv.appendChild(newCpuDiv);
        newFunctionDiv.appendChild(newMemDiv);
        // Add d3 stuff
        var cpuSvg = document.createElement("svg");
        var cpuSvgd3 = d3.select(cpuSvg);
        var data = monitorData.monitorHistoryData[functionList[i]];
        for (var i=0; i<data.length; i++) {
            data[i]["x"] = i;
            console.log(new Date(data[i]["SYS_time"]/1000000));
        }
        var cpud3 = setupD3Svg(cpuSvgd3, functionList[i], data, "x");
        var memSvg = document.createElement("svg");
        var memSvgd3 = d3.select(memSvg);
        var memd3 = setupD3Svg(memSvgd3, functionList[i], data, "MEM_used");
        newCpuDiv.appendChild(cpuSvg);
        newMemDiv.appendChild(memSvg);
        currentMonitorD3[functionList[i]] = {cpu:cpud3,mem:memd3};
        currentMonitorDivs[functionList[i]] = newFunctionDiv;
        functionDivList.push(newFunctionDiv);
    }
    currentMonitorFunctionList = functionList;
    for (var i=0; i<functionDivList.length; i++) {
        console.log("Add child to monitordiv");
        monitordiv.appendChild(functionDivList[i]);
    }
    currentMonitorData = monitorData;
}

function onMonitor(status, response) {
    if (status != 200)
        return;
    if (currentMonitorData == null) 
        createMonitorView(response);
    else
        updateMonitorView();
}

function getMonitor() {
    ajax("GET", serverPrefix+"/status/monitor", null, "json", onMonitor);
}

function init() {
    serverPrefix = window.location.protocol+"//"+window.location.host;
    // Check current status
    checkStatus();
}
</script>
</head>
<body onload="init();">
<div id="topstatus">
<span>Status: <strong><span id="status"></span></strong></span>
<button id="statusbtn" onclick="checkStatus();">Check</button>
<button id="undeploybtn" onclick="undeploy();" disabled="true">Undeploy</button>
</div>

<h3>Monitoring</h3>
<div id="monitordiv"></div>

<h3>Package list</h3>
<div id="pkglist"></div>

</body>
</html>
