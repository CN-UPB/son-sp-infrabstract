<html>
<head>
<script src="d3.v4.min.js"></script>
<script src="cola.v3.js"></script>
<script src="d3-scale.v1.min.js"></script>
<script src="d3-array.v1.min.js"></script>
<script src="d3-collection.v1.min.js"></script>
<script src="d3-color.v1.min.js"></script>
<script src="d3-format.v1.min.js"></script>
<script src="d3-interpolate.v1.min.js"></script>
<script src="d3-time.v1.min.js"></script>
<script src="d3-time-format.v2.min.js"></script>
<style>
body {
    margin:0;
}
#topstatus {
    border-bottom:solid 1px #000;
}
.vnfMonitor {
/*    background-color: #ddd;*/
    clear: both;
}
.vnfMonitorLabel {
    clear: both;
}
.vnfMonitorCpu {
    float: left;
    margin: 5px;
/*
    width: 500px;
    height: 400px;*/
    /*border: solid 1px #000;*/
}
.vnfMonitorMem {
    float: left;
    margin: 5px;
    /*width: 500px;
    height: 400px;*/
    /*border: solid 1px #000;*/
}
svg {
    border: solid 1px #000;
}
.plotline {
    fill: none;
    stroke: #f00;
}
.line {
    fill: none;
    stroke: #f00;
/*    stroke-width: 20; */
}
#monitordiv{
    clear:both;
}
</style>
<script type="text/javascript">

actionPending = false;
currentStatus = null;

function ajax(method, path, params, type, callback){
    var xmlHttp = null;
    xmlHttp = new XMLHttpRequest();
    if (xmlHttp) {
        xmlHttp.open(method, path, true);
        if (type != null)
            xmlHttp.responseType = type;
        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4) {
                callback(xmlHttp.status, xmlHttp.response);
            }
        };
        xmlHttp.send(params);
    }
}

function setStatusMsg(msg, style){
    var statusNode = document.getElementById("status");
    while(statusNode.childNodes.length>0)
        statusNode.removeChild(statusNode.firstChild);
    statusNode.style = style;
    statusNode.appendChild(document.createTextNode(msg));
}

function onStatus(status, response){
    if(status == 200) {
        newstatus = response;
        if(newstatus.status == "DEPLOYED") {
            document.getElementById("undeploybtn").disabled = false;
            setStatusMsg(newstatus.status, "color:green;");
            monitorLooping = true;
            getMonitor();
        }
        if(newstatus.status == "UNDEPLOYED") {
            document.getElementById("undeploybtn").disabled = true;
            setStatusMsg(newstatus.status, "color:red;");
            monitorLooping = false;
        }
        // Check for status change and update appropriate information
        if(currentStatus == null || currentStatus.packageCount != newstatus.packageCount)
            getPkgList();
        currentStatus = newstatus;
    } else {
        monitorLooping = false;
    }
    document.getElementById("statusbtn").disabled = false;
    actionPending = false;
}

function checkStatus(){
    document.getElementById("statusbtn").disabled = true;
    setStatusMsg("Checking Status", "color:orange;");
    ajax("GET", "/status/status", null, "json", onStatus);
}

function onUndeploy(status, response){
    checkStatus();
}

function undeploy() {
    if(actionPending == true)
        return;
    actionPending = true;
    document.getElementById("undeploybtn").disabled = true;
    setStatusMsg("Undeploying", "color:orange;");
    ajax("GET", "/undeploy", null, "json", onUndeploy);
}

function onDeploy(status, response){
    if(status == 201) {        
    } else {
    }
    checkStatus();
}

function deployPkg(index){
    if(actionPending == true)
        return;
    actionPending = true;
    setStatusMsg("Deploying", "color:orange;");
    ajax("POST", "/deploy", "asdf="+index, "json", onDeploy);
}

function setPkgList(status, response){
    console.log(response);
    if(status != 200) {
        console.log("Package request unsuccessful");
        return;
    }
    if (response != null) {
        var ul = document.createElement("ul");
        for (var i=0; i<response.length; i++) {
            var node = response[i];
            var li = document.createElement("li");
            var name = document.createTextNode(node.name+"  ");
            var btn = document.createElement("button");
            btn.appendChild(document.createTextNode("Deploy"));
            btn.addEventListener('click',deployPkg.bind(this,i));
            btn.class="deploybtn";
            li.appendChild(name);
            li.appendChild(btn);
            ul.appendChild(li);
        }
        var pkglist = document.getElementById("pkglist");
        while(pkglist.childNodes.length > 0)
            pkglist.removeChild(pkglist.firstChild);
        pkglist.appendChild(document.createTextNode("Packages: "+response.length));
        //pkglist.appendChild(document.createElement("br"));
        pkglist.appendChild(ul);
    }
}

function getPkgList() {
    ajax("GET", serverPrefix+"/status/packages", null ,"json", setPkgList);
}

var currentMonitorFunctionList = null;
var currentMonitorData = null;
var currentMonitorD3 = null;
var currentMonitorDivs = null;

function removeMonitorView() {
    var monitordiv = document.getElementById("monitordiv");
    while(monitordiv.childNodes.length > 0)
        monitordiv.removeChild(monitordiv.firstChild);
    currentMonitorData = null;
}

function updateMonitorView(monitorData) {
    if(currentMonitorData == null)
        return;
    var newFunctionList = monitorData.monitorFunctions;
    var newFunctions = [];
    var deletedFunctions = [];
    var oldFunctions = [];
    // Get new and old functions
    for(var i=0; i<newFunctionList.length; i++) {
        if(currentMonitorFunctionList.indexOf(newFunctionList[i])<0)
            newFunctions.push(newFunctionList[i]);
        else
            oldFunctions.push(newFunctionList[i]);
    }
    // Get deleted functions
    for(var i=0; i<currentMonitorFunctionList.length; i++) {
        if(newFunctionList.indexOf(currentMonitorFunctionList[i])<0)
            deletedFunctions.push(currentMonitorFunctionList[i]);
    }
    // Update label style for deleted functions
    for(var i=0; i<deletedFunctions.length; i++) {
        currentMonitorDivs[deletedFunctions[i]].firstChild.style = "text-decoration: line-through;";
    }
    // Create divs/d3 for new functions
    var monitordiv = document.getElementById("monitordiv");
    var functionDivList = [];
    for(var i=0; i<newFunctions.length; i++) {
        var newFunctionDiv = document.createElement("div");
        newFunctionDiv.setAttribute("class","vnfMonitor");
        var monitorLabelDiv = document.createElement("div");
        monitorLabelDiv.setAttribute("class","vnfMonitorLabel");
        monitorLabelDiv.appendChild(document.createTextNode(functionList[i]));
        var newCpuDiv = document.createElement("div");
        newCpuDiv.setAttribute("class","vnfMonitorCpu");
        var newMemDiv = document.createElement("div");
        newMemDiv.setAttribute("class","vnfMonitorMem");
        newFunctionDiv.appendChild(monitorLabelDiv);
        newFunctionDiv.appendChild(newCpuDiv);
        newFunctionDiv.appendChild(newMemDiv);
        // Add d3 stuff
        var cpuSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        cpuSvg.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:xlink", "http://www.w3.org/1999/xlink");
        var cpuSvgd3 = d3.select(cpuSvg);
        var cpud3 = setupD3Svg(cpuSvgd3, newFunctions[i], monitorData.monitorHistoryData[newFunctions[i]], "CPU_%");
        var memSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        memSvg.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:xlink", "http://www.w3.org/1999/xlink");
        var memSvgd3 = d3.select(memSvg);
        var memd3 = setupD3Svg(memSvgd3, newFunctions[i], monitorData.monitorHistoryData[newFunctions[i]], "MEM_%");
        newCpuDiv.appendChild(cpuSvg);
        newMemDiv.appendChild(memSvg);
        currentMonitorD3[newFunctions[i]] = {cpu:cpud3,mem:memd3};
        currentMonitorDivs[newFunctions[i]] = newFunctionDiv;
        functionDivList.push(newFunctionDiv);
    }
    for (var i=0; i<functionDivList; i++) {
        monitordiv.appendChild(functionDivList[i]);
    }
    // Update data for old functions
    for(var i=0; i<oldFunctions.length; i++) {
        var datapath = currentMonitorD3[oldFunctions[i]];
        var data = monitorData.monitorHistoryData[oldFunctions[i]];

        updateD3Svg(datapath.cpu, oldFunctions[i], data, "CPU_%", [0, data[0]["CPU_cores"]]);
        updateD3Svg(datapath.mem, oldFunctions[i], data, "MEM_used", [0, data[0]["MEM_limit"]]);

    }
    currentMonitorData = monitorData;
    currentMonitorFunctionList = newFunctionList;
}

function defineSvgSize(){
    var svgWidth = 500;
    var svgHeight = 400;
    var margin = {top: 20, right: 20, bottom: 20, left: 80};
    var width = svgWidth - margin.left - margin.right;
    var height = svgHeight - margin.top - margin.bottom;
   
    return {
        svgWidth: svgWidth,
        svgHeight: svgHeight,
        margin: margin,
        width: width,
        height: height
    };
}

function updateD3Svg(svg, name, data, dataKey, limit) {
    var sizes = defineSvgSize();
    var plot;
    svg.select(".plot")
        .attr("transform", "translate(" + sizes.margin.left + "," + sizes.margin.top + ")");
    
    var x = d3.scaleTime()
    .rangeRound([0, sizes.width]);
    var y = d3.scaleLinear()
    .rangeRound([sizes.height, 0]);

    var xextent = d3.extent(data, function(d) { return new Date(d["SYS_time"]/1000000); });
    //var yextent = d3.extent(data, function(d) { return d[dataKey]; });
    var yextent = limit;

    var line = d3.line()
    .x(function(d) { return x(new Date(d["SYS_time"]/1000000)); })
    .y(function(d) { return y(d[dataKey]); });
    x.domain(xextent);
    y.domain(yextent);

    svg.select(".axis--x")
        .attr("transform", "translate(0," + sizes.height + ")")
        .call(d3.axisBottom(x).ticks(10));
    svg.select(".axis--y")
        .call(d3.axisLeft(y).ticks(10));

    svg.select(".plotline")
        .datum(data)
        .attr("d", line);
    
}

function setupD3Svg(svg, name, data, dataKey, limit) {
    var sizes = defineSvgSize();
    svg.attr("width", sizes.svgWidth);
    svg.attr("height", sizes.svgHeight);
    var g = svg.append("g").attr("class", "plot");
    
    g.append("g")
       .attr("class", "axis axis--x");    

    g.append("g")
      .attr("class", "axis axis--y");

    g.append("path")
        .attr("class", "plotline");

    updateD3Svg(svg, name, data, dataKey, limit);
}

function createMonitorView(monitorData) {
    // first check monitor data
    if (monitorData.monitorHistoryData[monitorData.monitorFunctions[0]].length == 0)
        return;
    console.log("createMonitorView");
    var monitordiv = document.getElementById("monitordiv");
    var functionList = monitorData.monitorFunctions;
    var functionDivList = [];
    currentMonitorD3 = {};
    currentMonitorDivs = {};
    var dummy = [{"SYS_time":123,"CPU_used":123,"MEM_used":123},{"SYS_time":125,"CPU_used":123,"MEM_used":123},{"SYS_time":124,"CPU_used":123,"MEM_used":123}];
    console.log(functionList);
    console.log(functionList.length);
    for (var i=0; i<functionList.length; i++) {
        console.log("create div for function "+functionList[i]);
        var newFunctionDiv = document.createElement("div");
        newFunctionDiv.setAttribute("class","vnfMonitor");
        var monitorLabelDiv = document.createElement("div");
        monitorLabelDiv.setAttribute("class","vnfMonitorLabel");
        monitorLabelDiv.appendChild(document.createTextNode(functionList[i]));
        var newCpuDiv = document.createElement("div");
        newCpuDiv.setAttribute("class","vnfMonitorCpu");
        var newMemDiv = document.createElement("div");
        newMemDiv.setAttribute("class","vnfMonitorMem");
        newFunctionDiv.appendChild(monitorLabelDiv);
        newFunctionDiv.appendChild(newCpuDiv);
        newFunctionDiv.appendChild(newMemDiv);
        // Add d3 stuff
        var data = monitorData.monitorHistoryData[functionList[i]];

        //var cpuSvg = document.createElement("svg");
        var cpuSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        cpuSvg.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:xlink", "http://www.w3.org/1999/xlink");
        newCpuDiv.appendChild(cpuSvg);
        var cpuSvgd3 = d3.select(cpuSvg);
        setupD3Svg(cpuSvgd3, functionList[i], data, "CPU_%", [0, data[0]["CPU_cores"]]);


        var memSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        memSvg.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:xlink", "http://www.w3.org/1999/xlink");
        newMemDiv.appendChild(memSvg);
        //var memSvg = document.createElement("svg");
        var memSvgd3 = d3.select(memSvg);
        setupD3Svg(memSvgd3, functionList[i], data, "MEM_used", [0, data[0]["MEM_limit"]]);

        //document.getElementsByTagName("body")[0].appendChild(cpuSvg);

        currentMonitorD3[functionList[i]] = {cpu:cpuSvgd3,mem:memSvgd3};
        currentMonitorDivs[functionList[i]] = newFunctionDiv;
        functionDivList.push(newFunctionDiv);
        //bla(monitorData);
    }
    currentMonitorFunctionList = functionList;
    for (var i=0; i<functionDivList.length; i++) {
        console.log("Add child to monitordiv");
        monitordiv.appendChild(functionDivList[i]);
    }
    currentMonitorData = monitorData;
}



var monitorLooping = false;

function monitorLoop() {
    getMonitor();
}

function onMonitor(status, response) {
    if (status != 200)
        return;
    if (currentMonitorData == null) 
        createMonitorView(response);
    else
        updateMonitorView(response);
    if (monitorLooping == true)
        setTimeout(monitorLoop, 2000);
}

function getMonitor() {
    ajax("GET", serverPrefix+"/status/monitor", null, "json", onMonitor);
}

function init() {
    serverPrefix = window.location.protocol+"//"+window.location.host;
    // Check current status
    checkStatus();
}
</script>
</head>
<body onload="init();">
<div id="topstatus">
<span>Status: <strong><span id="status"></span></strong></span>
<button id="statusbtn" onclick="checkStatus();">Check</button>
<button id="undeploybtn" onclick="undeploy();" disabled="true">Undeploy</button>
</div>

<h3>Monitoring</h3>
<div id="monitordiv"></div>
<br/>
<h3 style="clear:both;">Package list</h3>
<div id="pkglist"></div>
</body>
</html>
